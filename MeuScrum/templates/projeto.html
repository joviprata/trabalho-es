<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto - MeuScrum</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="header">
        <div class="header-logo">
            <img src="{{ url_for('static', filename='Imagens/logo.png') }}" alt="MeuScrum Logo" onclick="window.location.href='/home'">
            <h2 onclick="window.location.href='/home'">MeuScrum</h2>
        </div>
        <div class="header-actions">
            <button class="btn-icon" onclick="window.location.href='/configuracoes'" title="Configura√ß√µes">
                üë§
            </button>
            <button class="btn-icon" onclick="window.location.href='/home'" title="Home">
                üìù
            </button>
            <button class="btn-icon" onclick="window.location.href='/logout'" title="Sair">
                üö™
            </button>
        </div>
    </div>
    
    <div class="container">
        <div id="alert-container"></div>
        
        <div class="content-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <button class="btn btn-back" onclick="window.history.back()">„Åè</button>
                    <h1 id="project-name" style="display:inline-block; vertical-align:middle;">Carregando...</h1>
                    <p id="project-dates" style="color: var(--text-light); margin-top: 0.5rem;"></p>
                </div>
                <div style="display: flex; gap: 1rem; align-items:center;">
                    <span id="project-status" class="project-status"></span>
                    <label for="role-select" style="font-size:0.9rem; margin-left:0.5rem;">Meu papel:</label>
                    <select id="role-select" class="form-control" style="width:170px;">
                        <option value="ProductOwner">Product Owner</option>
                        <option value="ScrumMaster">Scrum Master</option>
                        <option value="Developer">Developer</option>
                    </select>
                    <button id="btn-backlog" class="btn btn-secondary" onclick="window.location.href='/backlog/' + currentProjectId">Backlog de Produto</button>
                    <button id="btn-new-sprint" class="btn btn-primary" onclick="openNewSprintModal()">+ Nova Sprint</button>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h2>Sprints</h2>
            <div id="sprints-container" style="margin-top: 1.5rem;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nova Sprint -->
    <div id="newSprintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Sprint</h2>
                <button class="modal-close" onclick="closeNewSprintModal()">&times;</button>
            </div>
            <form id="newSprintForm">
                <div class="form-group">
                    <label for="sprint-titulo">T√≠tulo da Sprint</label>
                    <input type="text" id="sprint-titulo" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="sprint-datainicio">Data de In√≠cio</label>
                    <input type="date" id="sprint-datainicio" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="sprint-datafim">Data de T√©rmino</label>
                    <input type="date" id="sprint-datafim" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="sprint-status">Status</label>
                    <select id="sprint-status" class="form-control">
                        <option value="Planejada">Planejada</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Conclu√≠da">Conclu√≠da</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Criar Sprint</button>
                    <button type="button" class="btn btn-outline" onclick="closeNewSprintModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        let currentProjectId = "{{ proj_id }}";
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        async function loadProject() {
            try {
                const response = await fetch(`/api/projeto/${currentProjectId}`);
                const data = await response.json();
                
                if (data.projeto) {
                    const proj = data.projeto;
                    document.getElementById('project-name').textContent = proj.nome;
                    document.getElementById('project-dates').textContent = 
                        `In√≠cio: ${new Date(proj.datainicio).toLocaleDateString('pt-BR')}${proj.datafim ? ' | T√©rmino: ' + new Date(proj.datafim).toLocaleDateString('pt-BR') : ''}`;
                    document.getElementById('project-status').textContent = proj.status;
                    document.getElementById('project-status').className = `project-status status-${getStatusClass(proj.status)}`;
                    
                    if (data.backlog) {
                        document.getElementById('btn-backlog').setAttribute('onclick', `window.location.href='/backlog/${data.backlog.bp_id}'`);
                    }

                    // Set current user role if provided by API
                    const roleSelect = document.getElementById('role-select');
                    const papel = data.user_papel || null;
                    if (papel) {
                        // map values that might come from DB
                        if (papel === 'Product Owner') roleSelect.value = 'ProductOwner';
                        else if (papel === 'Scrum Master') roleSelect.value = 'ScrumMaster';
                        else roleSelect.value = papel;
                    } else {
                        // default to Desenvolvedor
                        roleSelect.value = 'Developer';
                    }
                    applyRolePermissions(roleSelect.value);
                }
                
                if (data.sprints && data.sprints.length > 0) {
                    const container = document.getElementById('sprints-container');
                    container.innerHTML = data.sprints.map(sprint => `
                        <div class="project-card" onclick="window.location.href='/sprint/${sprint.sprint_id}'">
                            <h3>${sprint.titulo}</h3>
                            <p>${new Date(sprint.datainicio).toLocaleDateString('pt-BR')} - ${new Date(sprint.datafim).toLocaleDateString('pt-BR')}</p>
                            <div class="project-meta">
                                <span class="project-status status-${getStatusClass(sprint.status)}">${sprint.status}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('sprints-container').innerHTML = 
                        '<p style="text-align: center; color: var(--text-light);">Nenhuma sprint encontrada. Crie sua primeira sprint!</p>';
                }
            } catch (error) {
                showAlert('Erro ao carregar projeto', 'error');
            }
        }
        
        function getStatusClass(status) {
            if (status === 'Conclu√≠da' || status === 'Conclu√≠do') return 'completed';
            if (status === 'Cancelada' || status === 'Pausado') return 'paused';
            return 'active';
        }
        
        function applyRolePermissions(papel) {
            // papel values: 'ProductOwner', 'ScrumMaster', 'Developer'
            const btnBacklog = document.getElementById('btn-backlog');
            const btnNewSprint = document.getElementById('btn-new-sprint');

            // Backlog: ProductOwner always enabled, ScrumMaster and Developer also enabled (can view)
            btnBacklog.disabled = false;
            btnBacklog.classList.remove('btn-disabled');

            // NewSprint: Only ScrumMaster can create sprints
            if (papel === 'ScrumMaster') {
                btnNewSprint.disabled = false;
                btnNewSprint.classList.remove('btn-disabled');
            } else {
                btnNewSprint.disabled = true;
                btnNewSprint.classList.add('btn-disabled');
            }
        }

        function openNewSprintModal() {
            const btn = document.getElementById('btn-new-sprint');
            if (btn.disabled) {
                showAlert('Apenas o Scrum Master pode criar sprints.', 'error');
                return;
            }
            document.getElementById('newSprintModal').classList.add('active');
        }
        
        function closeNewSprintModal() {
            document.getElementById('newSprintModal').classList.remove('active');
            document.getElementById('newSprintForm').reset();
        }
        
        document.getElementById('newSprintForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const titulo = document.getElementById('sprint-titulo').value;
            const datainicio = document.getElementById('sprint-datainicio').value;
            const datafim = document.getElementById('sprint-datafim').value;
            const status = document.getElementById('sprint-status').value;
            
            try {
                const response = await fetch('/api/sprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ projeto: currentProjectId, titulo, datainicio, datafim, status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeNewSprintModal();
                    showAlert('Sprint criada com sucesso!', 'success');
                    loadProject();
                } else {
                    showAlert(data.message || 'Erro ao criar sprint', 'error');
                }
            } catch (error) {
                showAlert('Erro ao conectar com o servidor', 'error');
            }
        });

        // role change handler
        document.getElementById('role-select').addEventListener('change', async (e) => {
            const papel = e.target.value;
            try {
                const resp = await fetch(`/api/projeto/${currentProjectId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ papel })
                });
                const r = await resp.json();
                if (r.success) {
                    showAlert('Papel atualizado: ' + r.papel, 'success');
                    applyRolePermissions(r.papel);
                } else {
                    showAlert(r.message || 'Erro ao atualizar papel', 'error');
                }
            } catch (error) {
                showAlert('Erro ao conectar com o servidor', 'error');
            }
        });
        
        document.getElementById('newSprintModal').addEventListener('click', (e) => {
            if (e.target.id === 'newSprintModal') {
                closeNewSprintModal();
            }
        });
        
        loadProject();
    </script>
</body>
</html>

